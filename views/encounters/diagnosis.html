<script type="text/javascript" src="/public/touchscreentoolkit/lib/javascripts/touchScreenToolkit.js"
        defer="true"></script>
<!-- <script type="text/javascript" src="/public/touchscreentoolkit/lib/javascripts/standard.js" defer="true"></script> -->
<script type="text/javascript" src="/assets/js/jquery.min.js"></script>

<script type="text/javascript" src="/assets/js/post_parameters.js"></script>
<script type="text/javascript" src="/assets/js/generic_ajaxrequest.js"></script>
<script type="text/javascript" src="/assets/js/moment.js"></script>
<script type="text/javascript" src="/assets/js/alertifyjs/alertify.js"></script>
<script type="text/javascript" src="/assets/js/does_connection_exist.js"></script>

<link rel="stylesheet" href="/assets/css/alertifyjs/css/alertify.css" type="text/css">


<link rel="stylesheet" href="/apps/OPD/assets/css/diagnosis.page.css" type="text/css">
<script type="text/javascript" src="/apps/OPD/assets/js/diagnosis.page.js"></script>

<script>
    var tt_cancel_destination = "/views/patient_dashboard.html?patient_id=" + sessionStorage.patientID;
    var malariaTestResult;

    function initializeVariables() {
        jQuery(".loader").show();
        jQuery('#keyboard').hide();
        jQuery("#buttons").hide();
        jQuery("#inputFrame" + tstCurrentPage).hide();

        var malaria_test_result_concept_id = 9227;

        var malaria_test_result_url = apiProtocol + "://" + apiURL + ":" + apiPort;
        malaria_test_result_url += "/api/v1/observations?person_id=" + sessionStorage.patientID;
        malaria_test_result_url += "&concept_id=" + malaria_test_result_concept_id;
        malaria_test_result_url += "&obs_datetime=" + sessionStorage.sessionDate;

        var xhttp1 = new XMLHttpRequest();
        xhttp1.onreadystatechange = function () {
            if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
                var malaria_test_result_observations = JSON.parse(this.responseText);
                if (malaria_test_result_observations.length > 0) {
                    var value_coded = malaria_test_result_observations[0].value_coded;
                    if (value_coded) {
                        var concept_name_url = apiProtocol + "://" + apiURL + ":" + apiPort;
                        concept_name_url += "/api/v1/concepts/" + value_coded;

                        var xhttp2 = new XMLHttpRequest();
                        xhttp2.onreadystatechange = function () {
                            if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
                                var concept = JSON.parse(this.responseText);
                                if (concept) {
                                    var concept_names = concept["concept_names"];
                                    for (var key in concept_names) {
                                        if (concept_names[key]["concept_name_type"].match(/FULLY_SPECIFIED/i)) {
                                            malariaTestResult = concept_names[key]["name"];
                                            break;
                                        }
                                    }
                                }
                                gotoNextPage();
                            }
                        };
                        xhttp2.open("GET", concept_name_url, true);
                        xhttp2.setRequestHeader('Authorization', sessionStorage.getItem("authorization"));
                        xhttp2.setRequestHeader('Content-type', "application/json");
                        xhttp2.send();
                    } else {
                        malariaTestResult = malaria_test_result_observations[0].value_text;
                        gotoNextPage();
                    }
                } else {
                    gotoNextPage();
                }
            }
        };
        xhttp1.open("GET", malaria_test_result_url, true);
        xhttp1.setRequestHeader('Authorization', sessionStorage.getItem("authorization"));
        xhttp1.setRequestHeader('Content-type', "application/json");
        xhttp1.send();
    }

    function resetPage() {
        jQuery('#keyboard').show();
        jQuery("#buttons").show();
        jQuery("#innerPop").show()
        jQuery("#inputFrame" + tstCurrentPage).show();
        jQuery(".loader").hide();
    }

    function changeNextButton() {
        var nextButton = document.getElementById('nextButton');
        nextButton.setAttribute('onmousedown', '');
    }

</script>


<style type="text/css">

    .loader {
        position: absolute;
        display: none;
        top: 30%;
        left: 40%;
        border: 16px solid #f3f3f3; /* Light grey */
        border-top: 16px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 120px;
        height: 120px;
        animation: spin 2s linear infinite;
        z-index: 9999999999999;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

</style>

<body id="mateme">
<div id="container">
    <div id="content">

        <form>
            <input type="text" name="initialize"
                   tt_onLoad="initializeVariables();"
                   tt_onUnLoad="resetPage();"
                   tt_pageStyleClass="NoControls" optional="true"/>


            <input type="text" name="summary"
                   tt_onLoad="__$('keyboard').style.display = 'none';changeNextButton();buildOPDdiagnosisPage();"
                   tt_pageStyleClass="NoControls" helpText="Diagnosis" optional="true"/>

        </form>

        <div class="loader"></div>
    </div>
</div>
</body>

